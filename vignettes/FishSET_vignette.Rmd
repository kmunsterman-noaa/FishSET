---
title: "Introduction to FishSET"
author: "ESSR"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to FishSET} 
  %\VignetteEngine{knitr::rmarkdown}  
  %\VignetteEncoding{UTF-8}
---
<!--output: html_document: default -->
<!--  pdf_document: default -->
<!-- word_document: inst/doc -->
<!--   pdf_document: inst/doc -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The Spatial Economics Toolbox for Fisheries (FishSET) is a set of statistical programming and data management tools developed to achieve the following goals:
 
  1. Standardize data management and organization. 
  1. Provide easily accessible tools to enable location choice models to provide input to the management of key fisheries.
  1. Organize statistical code so that predictions of fisher behavior developed by the fieldâ€™s leading innovators can be incorporated and transparent to all users.


The FishSET package provides functions for:

* Data management
* Data analysis
* Mapping
* Statistical modeling
* Reproducibility
  
FishSET is designed for reproducibility. 

* Data is stored in a SQLite database in the FishSET package directory called fishset_db. 
* Function calls are logged in a *Logs* folder.
* Output (plots, table, messages, notes) are saved in an *Output* folder. 
* Folders are located in the FishET package directory.

This vignette contains a brief description of the FishSET functions. A more detailed manual is available at the FishSET **WEBSITE**. 

## Getting started
To use FishSET you first need to install devtools and then FishSET.

Install devtools  (required to install FishSET)
: `install.packages("devtools")`   
 `library(devtools)`

Install FishSET  
: To install FishSET from GitHUB  
  `devtools::install_github("name/FishSET")`     

: To install FishSET from the R console  
    `install("PATH/TO/Directory/Containing/FishSET")`  
    `library(FishSET)`
    
Be sure to install dependencies.
	  
##Using FishSET
FishSET functions can be called in the R console or through the FishSET GUI. The FishSET GUI is a user-friendly guided user interface that requires no coding knowledge to run FishSET functions. To open the FishSET GUI type `run_fishset_gui()` in the R console. More details on using the FishSET GUI are provided in the *Quickstart Guide* tab in the FishSET GUI or the *FishSET GUI* vignette. This vignette focuses on calling functions in the R console.  

## Project
Distinct analyses and output are grouped by projects. The project name is attached to data and output. It is used to extract the correct the correct plots, tables, and notes when writing a report. The `project` argument can be any string.

```{r figLog, echo=FALSE, , out.width = '1%'}
knitr::include_graphics('C:/Users/melanie.harsch/Pictures/Screenshots/LogFolder.png')
```

## Data
FishSET uses five data types. 

```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "  

| File Type        | Description                                                                 |
|------------------|-----------------------------------------------------------------------------|
| Primary data     | Required file that contains the main data for the model.                    |
| Port data        | Required file with the latitude and longitude locations of ports.           |
| Gridded data     | Optional file that contains additional data that varies by two dimensions.  |
| Auxiliary data   | Optional file that contains additional data to link to the primary data.    |
| Spatial data     | Required file defining boundaries of fishery or regulatory zones.           |
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

All optional data files must be linkable to the primary data file.    
The spatial data file cannot be saved to the FishSET database.

FishSET will accept several data formats including:

  * csv files
  * geojson files
  * json files
  * matlab files
  * R files  
  * shape files
  * spss files
  * stata files
  * txt files
  * xls, xlsx files

###Saving to FishSET database
All data should be saved to the FishSET database and checked for issues that can affect saving the dataset to an SQL database. 

The load functions check that the data file can be saved to an the FishSET database and, if all checks pass, saves the data table.

Functons:
  
     load_maindata() Primary data file. 
     load_port()     SPort data file. 
     load_aux ()     Auxiliary data file. 
     load_grid()     Gridded data file.

When the primary data is saved, two versions of the data are created, a raw table with the orignal data and a working table on which all analyses will be conducted. The working table will also be available in the global environment.

###Reading data into R
The spatial data file cannot be saved to the FishSET database but must be read into R. 
To read spatial data files and other data into the working environment without saving to the FishSET database use `read_dat(x, data.type = NULL, is.map = F, ...)`. `x` is the name and path of the dataset to be read in. `data.type` is the data extensions and is optional. `is.map` should be TRUE is the dataset is a spatial data file. `...` is used to add additional extension-specific arguments. See function documentation for more details.  

Supported data extensions are:  

  *	csv 
  *	geojson
  *	json 
  *	mat
  *	R 
  *	shp 
  *	spss 
  *	dta
  *	txt
  *	xls
  * xlsx

###Loading data from FishSET database
Data saved to the FishSET database, can be reloaded into the global environment using 
:   `load_data(project, name=NULL)`. 

Specify the project name (`project`) and the table name (`name`). For example,
: `load_data("pollock"", name="pollockMainDataTable20200101")` 
loads the primary data from project *pollock*. `name` is optional and is used to specify a specific dated version of the data table.  


####Working in the FishSET database  
List tables are in the FishSET database, remove tables, view table attributes, and display the table in the R Console.


Basic functions:
 
     tables_database()      View list of all tables in the FishSET database.
     list_MainDataTables()	View list of MainDataTables in FishSET database.
     list_PortTables()	    View list of PortTables in FishSET database.
     list_logs()		        View list of all log files.
     table_fields(x)        View fields in specified table.
     table_view(x)          Display specified table.
     table_exists(x)	      Check whether specified table exists in the FishSET database.
     table_remove(x)	      Remove specified table table from the FishSET database.

     
 Model output files can be viewed in the FishSET database using:
     
     globalcheck_view(table)  View error output discrete choice models
     model_out_view(table)    Load discrete choice model output
 

### Data management functions
Data management functions provide tools for:

  Visualizing the data 
  
     summary_stats    Returns a tables with basic summary statistics for all variables in data table.
     spatial_hist     Returns historgram of latitude and longitude by grouping variable.
     spatial_summary  Returns line plots of selected variable against date and zone.
     getis_ord_stats  Returns plot and table of Getis Ord statistic
     moran_stats      Returns plot and table of Moran's I statistic

  Subsetting the data
  
     select_vars      Select which variables from raw data set to include in the working data set. 
     add_vars         Add varables from raw data set to working data set after the select_vars function has been run.

  Checking for outliers  
  
     outlier_table    Returns table with quantiles for all numeric variables in the data table
     outlier_plot     Returns a plot of the selected variable.
     outlier_remove   Returns modified data set where outliers have been removed.
  Checking for NaNs 
  
     nan_identify     Checks whether NAs or NaNs are present in any variable.
     nan_filter       Returns modified data set where NaNs have been removed or replaced.
     na_filter        Returns modified data set where NAs have been removed or replaced.
  Further filtering
  
     filter_table     Stores filter functions in a table.     
     filter_dat       Apply stored and new filter functions to data.
  Running multiple functions
  
     data_check        Calls the summary stats, outlier, and nan functions.
     data_verification Checks for unique column names, each row is a unique choice occurrence, etc.
     check_model_data  Checks for presence of NAs, NaNs and Inf in model data. 
  Other helpful functions
     
     degree            Convert lat/long from degree to decimal format
  



The data_check function calls several data management functions including, `summary_stats`, `nan_identify`, `outlier_table`, `outlier_plot`, and `data_verification`. The `nan_identify` and two outlier functions are meant to aid in identifying whether outlying points occur in the data set and identify the occurrence of NaNs in the data set. Outliers can be removed with `outlier_remove`. NaNs can be removed with `nan_filter`.

Further filtering of the data can be accomplished using the `filter_table` and `filter_dat` functions. The `filter_table` functions allows users define and save filter functions as a table. 

```{r table2, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- '   
| Data table      |   Vector       |  FilterFunction           |
|-----------------|----------------|---------------------------|
| MainDataTable   |  "PORT_CODE"   |  PORT_CODE == 1           |
| MainDataTable   |  "TRIP_START"  |  TRIP_START >= 2011-02-01 |
| PortDataTable   |  "LATITUDE"    |  LATITUDE < 57            |

'
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```


The filter functions can then be called and applied to the data using the `filter_dat` function.

The `data_verification` function runs more general checks on the data set at the time that the data is loaded into FishSET, including that all column names in the data set are unique, that specialized variables have been identified in the index data set, that no columns in the data set are empty, that units are defined and recognized, that each row is a unique choice occurrence at the haul or trip level, and that data for either latitude/longitude or fishing area are included. 

The `check_model_data` function checks that the data set meets several requirements, including no NA, NaN or INF values in the data and that each row is a unique occurrence at the haul or trip level. 

It is recommended that users first check their data using the `data_check` function before using the data creation or modeling functions. It is also recommended to run the `check_model_data` function before moving on to the modeling functions. There are several data creation functions that users may wish to run before moving on to generating models. These user-generated functions need to be checked for occurrences of NA, NaN, and Inf values before moving on to modeling.

### Data creation functions
Several functions exist that allow users to modify or create vectors and matrices. These functions are useful to ensure date vectors are in the correct format, to generate rate variables (such as catch/hours fished), calculating more complex variables such as trip distance, and adding variance to confidential data.

  Modify existing variables: 
  
     temp_mod   Transforms a date variable into desired units (year, month, month/day, minutes).
     set_quants Generates coded variable based on the quantiles. Useful for confidential data.
    
  Create nominal ID variables:
  
     ID_var                Generates a nominal variable to indicate distinct hauls or trips.
     create_seasonal_ID    Generates a fishery season identifier (TRUE/FALSE).
     fleet_table           Creates a table of fleet conditions for fleet assignment and saves to FishSET Database
     fleet_assign          Creates a nominal or dummy variable of fleet assignments based on fleet_table

  Create variables based on:
  
     create_var_num   Defined arithmetic function of two variables.
     cpue             Catch per unit effort.
     dummy_var        Vector of TRUE or FALSE the length  (rows) of the data set. 
     dummy_matrix     Matrix with same dimensions at the data set filled with TRUE or FALSE.
     
  Create spatial variables:
  
    create_dist_between Distance between lat/long points, port, and/or centroid of fishing zone/area
    create_mid_haul     Returns the midpoint location (lon/lat) for each haul
    create_duration     Duration of time between two temporal variables based on defined time format.
    create_startingloc  Returns vector of zone/area at point when choice of where to go next was made. Used with logit_correction likelihood.

  Trip level data and variables: 

     haul_to_trip   Collapse the data table from haul to trip.
     trip_distance  Summed distance across trip defined by start and end ports and hauls in between.
     trip_length    Computes trip duration defined by trip start and end dates. Can also create hauls per trip and cpue.

FishSET is not limited to the pre-defined functions. Users can create their own functions and then save them to the log file.

Log user-created functions:

    log_func_model   Saves the user-created function in the log file.

Before moving on, it is recommended that users run the `check_model_data` function to check for potential issues in variables created using the data creation functions.

## Data Exploration functions
Several functions are available for summarizing and visualizing fleet and species level data. These functions create tables and/or plots and allow users to select grouping variables, filter by year, and aggregate by time period. 
  
    vessel_count    Counts the total number of unique vessels active within a specified period.
    species_catch   Aggregates total catch for one or more species. 
    weekly_catch    Calculates weekly catch for one or more species.
    weekly_effort   Generates the average CPUE by week. 
    density_plot    Plots the KDE, CDF, or empirical CDF of variable.
    bycatch         Compares mean CPUE and share of total catch (or raw count) by specified time period

All tables and plots generated are saved to the output folder, logged, and printed to the plot pane or console. 

## Mapping functions

Mapping functions are in development

    map_kernel  Kernel density (hotspot) plots
 

## Modeling functions
For modeling, FishSET requires creating a model design file and then selecting the likelihood function and parameters.
Output from each model run is saved as two tables. A model comparison metric table saves AIC, AICc, BIC, PseudoR2. A model output table saves the full output from the model run including parameter estimates. 

(\emph{This section will be changed})
The create_expectations functions has three default cases that are generated along with a user-defined case. The near-term case uses uses the previous two days catch, the medium-term cases uses the previous seven days catch, and the longer-term uses the prevous seven days catch from one year prior. A user-defined case is also generated. Prior to running the create_expectations function, check that sufficient data exists for the desired moving window size using the temp_obs_table function. Shorter moving windows and temporal lags may result in numerous missing expected catch values if temporal data is sparse. All parameters defined in the create_expectations function call outside of window size and temporal lag size are applied to the three default cases and the user-defined case. 

Often it is desirable to compare output from different likelihood functions and/or alternate iterations of the data. In these cases, it is advised that users first run all desired likelihood functions before creating a new model design file. Descriptive model names are essential for identifying the different choices in the model output. More details are provided in the `Run Models` section below.

### Create model design functions
  The following functions are called indirectly
  
     assignment_column  Assigns each observation to a zone based on latitude and longitude.
     find_centroid      Returns the center of a zone or area based on set of latitude and longitudes. 
  
  The following functions should be called in the order listed. 
  
    create_alternative_choice Alternative choice matrix. Calls assignment_column and find_centroid functions.
    temp_obs_table            View number of observations by year, month, and zone.
    create_expectations       Expectation of catch for alternative choices.
    make_model_design         Model design file that contains data to be used in the model runs.


### Run model functions  
  The following functions are called indirectly
  
     shift_sort_x         Shifts choices so that the chosen zone will be automatically the first one.
     create_logit_input   Creates a data matrix that is consistent with the built-in model forms.
    
  Multiple likelihood functions have been included in FishSET. Users can also write their own likelihood functions and then save them in the log file using the `log_func_model` function.
  
     logit_c       Conditional logit function
     logit_avgcat  Average catch logit function
     logit_correction  Full information model with Dahl's correction function. Requires the create_startingloc function.
     epm_normal    Expected profit model with a normally distributed catch function
     epm_lognormal Expected profit model with a log-normally distributed catch function
     epm_weibull  Expected profit model with a Weibull distributed catch function
    
  Log user-created likelihood functions:
  
    log_func_model Saves the user created likelihood function in the log file.
    
  Running models
  
    discrete_fish_subroutine Runs model based on model design file and defined likelihood function.
    
  Viewing 
  
    select_model Open an interactive table displaying model fit and model comparison measures.
    globalcheck_view(table)  View error output generated from discrete choice models
    model_out_view(table)    View output from discrete choice models for models that converged
    

## Model design file details

## Model run details
The discretefish_subroutine function runs the selected model based on the selected data, parameters, and likelihood function. The function will run through each of the expected case tables. Three output tables are generated, a table containing information for assessing errors and why the model did not converge, a table containing model fit and model comparison mesaures, and a table containing the model output for models that converged. Each table contains output from each expected catch table and are labeled by the expected catch case (short_exp, med_exp, long_exp, user_defined_exp) and an identifier for the model.

### Data
User supplies all necessary data via the model design file. This data includes `catch`, `choice`, and `distance` data, plus any other data `otherdat` they need to run their chosen likelihood. The data `catch` and `choice` should be data frames with dimensions *(number of observations) x 1*. The data `otherdat` can include predicted catch, interactions, and gridded data.

The `distance` data should be a data frame with dimensions *(number of observations) x (number of alternatives)*.

Other data may be something like `predicted_catch` for each alternative (e.g. a data frame with dimensions *(number of observations) x (number of alternatives)*). 
This data is constructed by the user before estimation of the discrete choice model, for example by looking at a moving average of historical catches. The `create_expectations` function generates the `predicted_catch` data which is stored in the model design file. Other data, such as harvester characteristics, can also be included and should be defined at the time the model design file is created. 

For the `logit_c` function, any number of grid-varying variables (e.g. expected catch that varies by location) or interaction 
variables (e.g. vessel characteristics that affect how much disutility is suffered by traveling a greater distance) are allowed. 
However, the user must place these in `otherdat` as list objects named `griddat` and `intdat` respectively. Note the variables 
within `griddat` and `intdat` have no naming restrictions. Also note that `griddat` variables are dimension 
*(number of observations) x (number of alternatives)*, while `intdat` variables are dimension *(number of observations) x 1*,
to be interacted with the distance to each alternative. Again, grid-varying variables and interactive variables should be defined in the model design files using the `make_model_design` function.

If there are no other data, then `griddat` is set as ones with dimension *(number of observations) x (number of alternatives)* and `intdat` variables as ones with dimension *(number of observations) x 1*. Finally, users can write their own likelihoods and save these likelihoods using the `log_func_model` function.

### Run models 
To run models, call the `discretefish_subroutine` function. All data are stored in a table in the SQLite database using the `make_model_design` function. The user also supplies initial parameters, optimization options, and the likelihood function name, for a total of 7 total inputs.
For example:
  
    Initial parameters for revenue then cost.                   initparams <- c(2.5, -0.8)          
    Optimization options for maximum iterations, relative       optimOpt <- c(1000, 1.00e-08, 1, 1)
      tolerance of x, report frequency, and whether to report.
    Conditional logit likelihood function.                      func <- logit_c 
    Optimization method from base R `optim` options.            methodname <- "BFGS"


The subroutine function takes in 7 inputs and outputs model results in a list that can be summarized as:

	 errorExplain   If it exists, a description of the model error.
	 OutLogit       A matrix of coefficients, standard errors, and t-statistics 
	 optoutput      Optimization information (such as number of function iterations)
	 seoutmat2      Standard errors
	 MCM            Model comparison metrics (e.g. AIC, BIC)
	 H1             The inverse hessian 

When calling the `discretefish_subroutine` function users must provide a descriptive name for the model run `mod.name`. As output from each model run is saved, this parameter is used to differentiate between model runs and should be descriptive enough for users to identify between models runs. If true, `select.model` parameter opens an interactive table that allows users to select top model runs or delete model runs that do not need to be saved. More details are provided below. The `project` parameter is for naming the model output table in the database and distinguishing it from other projects. The `name` parameter is used in the logging function to reproduce work flow. It is the desired name of the output.

`discretefish_subroutine(project, initparams, optimOpt, func, methodname, mod.name, select.model=FALSE, name='results')`

### Scenarios 


### Selecting model runs with the `select.model` parameter
After running all desired model runs, it may be desirable to compare model runs and identify the best model run.
Both viewing and saving model runs can be accomplished by either setting the `select.model` parameter in the `discretefish_subroutine` function to TRUE or by running the `select_model` function. Both the `select.model` parameter and the `select_model` function will open an interactive data table similar to the figure below. 

```{r pressure, echo=FALSE, fig.cap="Example of interactive table", out.width = '1%'}
knitr::include_graphics('C:/Users/melanie.harsch/Pictures/Screenshots/ModelOutTable.png')
```

The table shows the model comparison metrics AIC, AICc, BIC, and PsuedoR2 for each of the model runs. In this example, the model runs are 'func.name2', 'newlogic', and 'newlogit2'. To the right of the table is a 'Select' column. Selecting a box results in a table saved to the database that looks similar to this table

```{r pressure2, echo=FALSE, fig.cap="Example of interactive table output", out.width = '1%'}
knitr::include_graphics('C:/Users/melanie.harsch/Pictures/Screenshots/TableSaved.png')
```


